<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
<title>勤務スケジュールアプリ - UI v1</title>
<link rel="stylesheet" href="styles.css?v=20251031">

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#0ea5e9" />
</head>


<body>
  <!-- ログイン画面 -->
  <section id="loginView" class="view active">
    <div class="card login-card">
      <h1 class="app-title">勤務スケジュール</h1>
      <form id="loginForm" autocomplete="off">
        <label class="lbl" for="loginId">ID</label>
        <input id="loginId" class="txt" type="text" required placeholder="例：admin01"/>

        <label class="lbl" for="loginPw">Password（8文字以上）</label>
        <input id="loginPw" class="txt" type="password" required minlength="8"
               placeholder="8文字以上（記号・日本語OK）"/>
        <button class="btn btn-primary w-100" type="submit">ログイン</button>

        <p id="loginError" class="error" aria-live="polite"></p>

      </form>

      <!-- ★追加：割り当て結果はクラウド保存されない案内 -->
      <div class="login-note" role="note" aria-label="データ保存に関する重要なお知らせ">
        <div class="login-note-title">重要なお知らせ</div>
        <div class="login-note-body">
          割り当て結果（勤務表）はクラウド保存されません。<br>
          別デバイスで作業する場合は、<strong>エクスポートで保存 → 別デバイスでインポート</strong>してください。<br>
          <span class="login-note-sub">※従業員設定・人数設定のみクラウド同期されます</span>
        </div>
      </div>

      <!-- 指南書ボタンを追加 -->
      <a href="manual.html" target="_blank" class="btn btn-outline w-100" style="margin-top:12px;">
        📘 指南書を開く
      </a>


      <div id="loginLoading" class="login-loading hidden" aria-live="polite">

        <div class="login-loading-inner">
          <div class="login-loading-icon">🩺</div>
          <div class="login-loading-text">
            勤務表を準備中…
            <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- アプリ本体 -->
  <section id="appView" class="view">
    <header class="topbar">
      <div class="left">
        <button id="btnJumpMonth" class="btn btn-ghost" type="button" aria-haspopup="dialog">任意の月に移動</button>
        <input id="monthPicker" type="month" class="hidden" />
        <button id="btnPrevDay" class="btn btn-outline" type="button" title="1日戻る">◀ 前日</button>
        <button id="btnNextDay" class="btn btn-outline" type="button" title="1日進む">翌日 ▶</button>
        <div class="period">表示：<span id="periodText">----</span></div>
      </div>
      <div class="right">
        <button id="btnAttrOpen" class="btn btn-outline" type="button" title="従業員の属性を編集">従業員編集</button>
        <button id="btnCountsOpen" class="btn btn-outline" type="button" title="日勤・夜勤の人数設定">人数設定</button>
        <button id="btnAutoAssign" class="btn btn-primary" type="button">自動割り当て</button>
        <button id="btnCancel" class="btn btn-outline" type="button">キャンセル</button>
        <button id="btnGlobalLock" class="btn btn-outline" type="button" title="指定された4週間をロック（編集禁止）">🔓 4週間ロック</button>
       <button id="btnFullCancel" class="btn btn-danger" type="button" title="完全クリア（4週間の全データ消去）">完全クリア</button>
        <button id="btnExportXlsx" class="btn btn-outline" type="button" title="表示中4週間をExcelで出力">📤 エクスポート</button>

        <button id="btnImportData" class="btn btn-outline" type="button" title="CSV/Excelから割り当てデータをインポート">📥 インポート</button>
        <button id="btnLogout" class="btn btn-danger" type="button" title="ログアウト時は自動保存">ログアウト</button>
        <button id="installBtn" style="display:none;">インストール</button>
      </div>
    </header>

    <div class="toolbar">
      <div class="tool">
        <label for="employeeCount">従業員数</label>
        <select id="employeeCount" class="select"></select>
      </div>


<!-- 追加：日本の祝日を自動取得 -->
      <div class="tool">
        <button id="btnHolidayAuto" class="btn btn-outline" type="button"
                title="日本の祝日を自動で取り込む">祝日自動取得</button>
      </div>

      <div class="tool">
        <button id="btnLockRange" class="btn btn-outline" type="button"
                title="選択範囲を自動割当から保護（上書きしない）">範囲ロック</button>
        <button id="btnUnlockRange" class="btn btn-outline" type="button"
                title="選択範囲のロックを解除">範囲ロック解除</button>
      </div>

<div class="tool">
  <span class="hint">モード：</span>
  <label><input type="radio" name="mode" value="off"> 希望休</label>
  <label><input type="radio" name="mode" value="assign"> 割当</label>
  <label><input type="radio" name="mode" value="clear"> クリア</label>
</div>

      <div class="tool">
        <span class="hint">特別休暇：</span>
        <button id="btnLeaveHoliday" class="btn btn-outline" type="button" title="祝日に休んだ人（4週8休では勤務日に数える）">祝</button>
        <button id="btnLeaveSub"     class="btn btn-outline" type="button" title="代休（4週8休では勤務日に数える）">代</button>
        <button id="btnLeavePaid"    class="btn btn-outline" type="button" title="有給（4週8休では勤務日に数える）">年</button>
        <button id="btnLeaveRefresh" class="btn btn-outline" type="button" title="リフレッシュ休暇（4週8休では勤務日に数える）">リ</button>
        <span class="hint">※ ボタン押下で該当モード → セルクリックで設定/解除（設定中は通常操作で上書き不可）</span>
      </div>

      <div class="tool hint">※ ヘッダー日付クリック＝祝日トグル / 「希望休」モードではセルクリック＝休トグル / 「割当」モードではセルクリック＝選択マークを配置（同じマークで消去）</div>

<div id="cloudIndicator" class="cloud-indicator" title="クラウド同期状態">未接続</div>


</div>  <!-- ← ここで .toolbar を閉じる -->


    <div id="gridWrap" class="grid-wrap" tabindex="0" aria-label="勤務表（ドラッグで月移動）">
      <table id="grid" class="grid" aria-describedby="periodText">
        <!-- JSで描画 -->

      </table>
    </div>

  </section>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <style>
    .cloud-indicator{
      display:inline-flex; align-items:center; gap:.4rem;
      font-size:12px; padding:2px 8px; border-radius:9999px; border:1px solid #ddd;
    }
    .cloud-indicator::before{ content:""; width:8px; height:8px; border-radius:50%; background:#aaa; }
    .cloud-indicator.online{ color:#065f46; border-color:#a7f3d0; }
    .cloud-indicator.online::before{ background:#10b981; }
    .cloud-indicator.offline{ color:#7f1d1d; border-color:#fecaca; }
    .cloud-indicator.offline::before{ background:#ef4444; }
/* 特定日固定条件の入力フィールド幅を統一 */
.fixed-num-input {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  min-width: 80px;  /* テーブルのセル幅に合わせる */
}

.fixed-num-input .txt {
  flex: 1;
  min-width: 50px;  /* 最小幅を確保 */
}
  </style>

  <!-- 属性ダイアログ -->


  <dialog id="attrDlg" class="attr">

    <header>従業員名・属性の編集</header>
    <div class="content" id="attrContent"></div>
    <footer>
      <button id="attrClose" class="btn btn-outline" type="button">閉じる</button>
      <button id="attrSave" class="btn btn-accent" type="button">保存</button>
    </footer>
  </dialog>

<dialog id="fullCancelDlg" class="attr">
  <header>完全クリア</header>
  <div class="content">
    <p>4週間の割当・希望休・特別休暇・ロックをすべて消去します。よろしいですか？</p>
  </div>
  <footer>
    <button id="fullCancelAll"  class="btn btn-danger"  type="button" title="4週間の割当・希望休・特別休暇・ロックをすべて消去">実行</button>
    <button id="fullCancelClose" class="btn btn-outline" type="button">キャンセル</button>
  </footer>
</dialog>


<dialog id="countsDlg" class="attr">
  <header>人数設定</header>
  <div class="content">
    <div class="row">
      <div class="counts-and-fixed-options">
 
      </div>
    </div>
    <div class="row">
      <div id="countsTableWrapper">
        <table class="counts-table">
          <thead>
            <tr>
              <th></th>
              <th>日勤全員</th>
              <th>早出</th>
              <th>遅出</th>
              <th>準夜</th>
              <th>深夜</th>
            </tr>
          </thead>
          <tbody>
    <tr>
      <th>平日</th>
      <td><input id="cfgDayTarget" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgEarlyTargetWeekday" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgLateTargetWeekday" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgFixedNF" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgFixedNS" type="number" class="txt" min="0" step="1"></td>
    </tr>
    <tr>
      <th>土日祝</th>
      <td><input id="cfgDayTargetWkHol" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgEarlyTargetWkHol" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgLateTargetWkHol" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgFixedNFHoliday" type="number" class="txt" min="0" step="1"></td>
      <td><input id="cfgFixedNSHoliday" type="number" class="txt" min="0" step="1"></td>
    </tr>
  </tbody>
</table>



    <div class="row row-fixed-by-date">
      <label>特定日 固定条件</label>
      <div class="fixed-block">
        <div class="fixed-control-row">
          <input id="cfgFixedDate" type="date" class="txt">
          <div class="fixed-num fixed-num-input">
            <span class="fixed-mark">日勤全員</span>
            <input id="cfgFixedDay" type="number" class="txt" min="0" step="1">
          </div>
          <div class="fixed-num fixed-num-input">
            <span class="fixed-mark">早出</span>
            <input id="cfgFixedEarlyDate" type="number" class="txt" min="0" step="1">
          </div>
          <div class="fixed-num fixed-num-input">
            <span class="fixed-mark">遅出</span>
            <input id="cfgFixedLateDate" type="number" class="txt" min="0" step="1">
          </div>
          <div class="fixed-num fixed-num-input">
            <span class="fixed-mark">準夜</span>
            <input id="cfgFixedNFDate" type="number" class="txt" min="0" step="1">
          </div>
          <div class="fixed-num fixed-num-input">
            <span class="fixed-mark">深夜</span>
            <input id="cfgFixedNSDate" type="number" class="txt" min="0" step="1">
          </div>
          <button id="btnFixedByDateAdd" class="btn btn-outline" type="button">追加</button>
        </div>
        <textarea id="cfgFixedByDate" class="txt fixed-text" rows="4"
                  placeholder="2025-11-03 8 1 1 3 3&#10;2025-11-04 7 1 1 2 3"></textarea>
        <div class="fixed-hint">
          1行ごとに「日付 日勤全員 早出 遅出 準夜 深夜」を入力（例: 2025-11-03 8 1 1 3 3）。
          日付だけの行はその日の固定解除として扱われます。
        </div>
      </div>
    </div>



  <footer>

    <button id="countsClose" class="btn btn-outline" type="button">閉じる</button>
    <button id="countsSave"  class="btn btn-accent"  type="button">保存</button>

    </footer>
  </dialog>

  <script src="marks.js"></script>
  <script src="shiftDurations.js"></script>
  <script src="counts.config.js"></script>
  <script src="rules.js"></script>
  <script src="holidayRules.js"></script>
  <script src="assignRules.js"></script>
  <script src="nightBand.js"></script>
  <script src="core.dates.js"></script>


  <script>
    window.REMOTE_ENDPOINT = "https://script.google.com/macros/s/AKfycbyIhYVUv8McMdZknoCHtpuXsGp-T7Xcg4txHna5WaQatbBrkr3FDOvZeBDjbpi96vpA/exec";
  </script>
  <script src="gasClient.js"></script>
  <script src="auth.js"></script>
  <script src="pwa.js"></script>
  <script src="employeeDialog.js"></script>
  <script src="dataExportImport.js"></script>
  <script src="app.js"></script>
  <script src="buttonHandlers.js"></script>
  <script src="cellOperations.js"></script>
  <script src="autoAssignLogic.js"></script>
</body>
</html>